<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StratifyAI - Multi-Provider LLM Interface</title>
    <!-- Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #667eea;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header h1 img {
            height: 50px;
            width: auto;
        }
        
        .header p {
            color: #666;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }
        
        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }
        
        .sidebar h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        select, textarea, input, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .main-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .chat-container {
            border: 1px solid #ddd;
            border-radius: 5px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            padding: 15px;
            background: #f9f9f9;
            margin-bottom: 15px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }
        
        .message.assistant {
            background: white;
            border: 1px solid #ddd;
        }
        
        .message.system {
            background: #f0f0f0;
            font-style: italic;
            max-width: 100%;
        }
        
        .message.error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            max-width: 100%;
        }
        
        /* Markdown content styling */
        .message.assistant .markdown-content {
            line-height: 1.6;
        }
        
        .message.assistant .markdown-content p {
            margin: 0 0 10px 0;
        }
        
        .message.assistant .markdown-content p:last-child {
            margin-bottom: 0;
        }
        
        .message.assistant .markdown-content pre {
            background: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 12px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .message.assistant .markdown-content code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 13px;
        }
        
        .message.assistant .markdown-content :not(pre) > code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .message.assistant .markdown-content ul,
        .message.assistant .markdown-content ol {
            margin: 10px 0;
            padding-left: 24px;
        }
        
        .message.assistant .markdown-content li {
            margin: 4px 0;
        }
        
        .message.assistant .markdown-content h1,
        .message.assistant .markdown-content h2,
        .message.assistant .markdown-content h3,
        .message.assistant .markdown-content h4 {
            margin: 16px 0 8px 0;
            font-weight: 600;
        }
        
        .message.assistant .markdown-content h1 { font-size: 1.4em; }
        .message.assistant .markdown-content h2 { font-size: 1.25em; }
        .message.assistant .markdown-content h3 { font-size: 1.1em; }
        
        .message.assistant .markdown-content blockquote {
            border-left: 4px solid #ddd;
            margin: 10px 0;
            padding: 8px 16px;
            color: #666;
            background: #f9f9f9;
        }
        
        .message.assistant .markdown-content table {
            border-collapse: collapse;
            margin: 10px 0;
            width: 100%;
        }
        
        .message.assistant .markdown-content th,
        .message.assistant .markdown-content td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        
        .message.assistant .markdown-content th {
            background: #f6f8fa;
            font-weight: 600;
        }
        
        .message.assistant .markdown-content hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 16px 0;
        }
        
        .message.assistant .markdown-content a {
            color: #667eea;
            text-decoration: none;
        }
        
        .message.assistant .markdown-content a:hover {
            text-decoration: underline;
        }
        
        .error-details {
            font-size: 12px;
            margin-top: 8px;
            padding: 8px;
            background: #fff;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .cost-tracker {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        
        .cost-tracker h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        /* Tabs styling */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e5e5e5;
            margin-bottom: 15px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
            width: auto;
        }
        
        .tab-btn:hover {
            color: #667eea;
            background: #f5f5f5;
        }
        
        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: transparent;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .history-item {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-role {
            font-weight: 500;
            margin-right: 8px;
        }
        
        .history-role.user { color: #667eea; }
        .history-role.assistant { color: #22c55e; }
        
        .history-content {
            color: #444;
        }
        
        .history-empty {
            color: #999;
            font-style: italic;
            padding: 15px;
            text-align: center;
        }
        
        .validation-status {
            font-size: 13px;
            margin-top: 8px;
            padding: 6px 10px;
            border-radius: 4px;
            background: #f0f9ff;
            border-left: 3px solid #3b82f6;
        }
        
        .validation-status.success {
            background: #f0fdf4;
            border-left-color: #22c55e;
            color: #166534;
        }
        
        .validation-status.warning {
            background: #fffbeb;
            border-left-color: #f59e0b;
            color: #92400e;
        }
        
        .validation-status.loading {
            background: #f3f4f6;
            border-left-color: #6b7280;
            color: #374151;
        }
        
        .cost-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }
        
        .cost-row:last-child {
            border-bottom: none;
            font-weight: bold;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="/static/stratifyai_wide_logo.png" alt="StratifyAI Logo">
        </div>
        
        <div class="main-grid">
            <div class="sidebar">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="config">‚öôÔ∏è Config</button>
                    <button class="tab-btn" data-tab="files">üìÅ Files</button>
                    <button class="tab-btn" data-tab="history">üìú History</button>
                    <button class="tab-btn" data-tab="cost">üí∞ Cost</button>
                </div>
                
                <!-- Config Tab -->
                <div id="tab-config" class="tab-content active">
                    <div class="form-group">
                        <label for="provider">Provider</label>
                        <select id="provider">
                            <option value="">Select Provider...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="model">Model</label>
                        <select id="model">
                            <option value="">Select Model...</option>
                        </select>
                        <div id="validation-status" class="validation-status" style="display: none;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="temperature">Temperature: <span id="temp-value">0.7</span></label>
                        <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7">
                    </div>
                    
                    <div class="form-group">
                        <label for="max-tokens">Max Tokens (optional)</label>
                        <input type="number" id="max-tokens" placeholder="Leave empty for default">
                    </div>
                    
                    <div class="form-group">
                        <button id="reset-chat">Reset Chat</button>
                    </div>
                </div>
                
                <!-- Files Tab -->
                <div id="tab-files" class="tab-content">
                    <div class="form-group">
                        <label for="file-input" id="file-input-label">Attach File - Text files only</label>
                        <input type="file" id="file-input" accept=".txt,.py,.js,.json,.csv,.log,.md,.yaml,.yml,.xml,.html,.css,.java,.go,.rs,.cpp,.c,.h">
                        <div id="file-status" style="margin-top: 5px; font-size: 13px; color: #666;"></div>
                    </div>
                    
                    <div class="form-group" style="display: flex; gap: 10px; align-items: center;">
                        <input type="checkbox" id="chunked" style="width: auto;">
                        <label for="chunked" style="margin: 0; cursor: pointer; font-size: 13px;">Enable Smart Chunking</label>
                    </div>
                    
                    <div class="form-group" id="chunk-size-group" style="display: none;">
                        <label for="chunk-size">Chunk Size: <span id="chunk-size-value">50,000</span> chars</label>
                        <input type="range" id="chunk-size" min="10000" max="100000" step="10000" value="50000">
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">üí° Smaller chunks = more summaries</div>
                    </div>
                </div>
                
                <!-- History Tab -->
                <div id="tab-history" class="tab-content">
                    <div id="history-list" style="max-height: 350px; overflow-y: auto;">
                        <div class="history-empty">No messages yet</div>
                    </div>
                </div>
                
                <!-- Cost Tab -->
                <div id="tab-cost" class="tab-content">
                    <div class="cost-row">
                        <span>Context:</span>
                        <span id="context-window">-</span>
                    </div>
                    <div class="cost-row">
                        <span>Calls:</span>
                        <span id="cost-calls">0</span>
                    </div>
                    <div class="cost-row">
                        <span>Tokens:</span>
                        <span id="cost-tokens">0 (In: 0, Out: 0)</span>
                    </div>
                    <div class="cost-row">
                        <span>Total Cost:</span>
                        <span id="cost-total">$0.0000</span>
                    </div>
                    <div class="form-group" style="margin-top: 15px; margin-bottom: 0;">
                        <a href="/models" class="view-models-btn" style="display: block; text-align: center; background: #667eea; color: white; padding: 10px; border-radius: 5px; text-decoration: none; font-weight: 500; transition: background 0.3s;">üìã View Model Catalog</a>
                    </div>
                </div>
            </div>
            
            <div class="main-content">
                <h3>Chat Interface</h3>
                <div class="chat-container" id="chat-container"></div>
                
                <div class="form-group">
                    <textarea id="user-input" placeholder="Type your message here..."></textarea>
                </div>
                
                <div class="form-group">
                    <button id="send-btn">Send Message</button>
                </div>
                
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8080';
        let messages = [];
        let totalCost = 0;
        let totalCalls = 0;
        let totalTokens = 0;
        let totalPromptTokens = 0;
        let totalCompletionTokens = 0;
        
        // Load providers on startup
        async function loadProviders() {
            const response = await fetch(`${API_BASE}/api/providers`);
            const providers = await response.json();
            
            const select = document.getElementById('provider');
            providers.forEach(provider => {
                const option = document.createElement('option');
                option.value = provider;
                option.textContent = provider.charAt(0).toUpperCase() + provider.slice(1);
                select.appendChild(option);
            });
        }
        
        // List of reasoning models that don't support temperature
        const REASONING_MODELS = [
            'o1', 'o1-mini', 'o1-preview', 'o3-mini',
            'o1-2024-12-17', 'o1-mini-2024-09-12',
            'deepseek-reasoner', 'gpt-5'
        ];
        
        // Check if model is a reasoning model
        function isReasoningModel(model) {
            if (!model) return false;
            const modelLower = model.toLowerCase();
            // Check explicit list or patterns
            return REASONING_MODELS.some(rm => modelLower.includes(rm.toLowerCase())) ||
                   modelLower.startsWith('o1') ||
                   modelLower.startsWith('o3') ||
                   modelLower.startsWith('gpt-5') ||
                   modelLower.includes('reasoner') ||
                   modelLower.includes('reasoning');
        }
        
        // Update temperature slider state based on model
        async function updateTemperatureState() {
            const provider = document.getElementById('provider').value;
            const model = document.getElementById('model').value;
            const tempSlider = document.getElementById('temperature');
            const tempLabel = tempSlider.previousElementSibling;
            
            if (!provider || !model) return;
            
            try {
                // Fetch model metadata from API
                const response = await fetch(`${API_BASE}/api/model-info/${provider}/${model}`);
                if (!response.ok) {
                    // Fallback to pattern matching if API fails
                    if (isReasoningModel(model)) {
                        tempSlider.disabled = true;
                        tempSlider.value = 1.0;
                        document.getElementById('temp-value').textContent = '1.0 (fixed)';
                        tempLabel.style.opacity = '0.5';
                    } else {
                        tempSlider.disabled = false;
                        tempLabel.style.opacity = '1';
                        document.getElementById('temp-value').textContent = tempSlider.value;
                    }
                    return;
                }
                
                const modelInfo = await response.json();
                
                // Check if model has fixed temperature
                if (modelInfo.fixed_temperature !== null && modelInfo.fixed_temperature !== undefined) {
                    tempSlider.disabled = true;
                    tempSlider.value = modelInfo.fixed_temperature;
                    document.getElementById('temp-value').textContent = `${modelInfo.fixed_temperature} (fixed)`;
                    tempLabel.style.opacity = '0.5';
                } else {
                    tempSlider.disabled = false;
                    tempLabel.style.opacity = '1';
                    document.getElementById('temp-value').textContent = tempSlider.value;
                }
            } catch (error) {
                console.error('Error fetching model info:', error);
                // Fallback to pattern matching
                if (isReasoningModel(model)) {
                    tempSlider.disabled = true;
                    tempSlider.value = 1.0;
                    document.getElementById('temp-value').textContent = '1.0 (fixed)';
                    tempLabel.style.opacity = '0.5';
                } else {
                    tempSlider.disabled = false;
                    tempLabel.style.opacity = '1';
                    document.getElementById('temp-value').textContent = tempSlider.value;
                }
            }
        }
        
        // Load models for selected provider
        document.getElementById('provider').addEventListener('change', async (e) => {
            const provider = e.target.value;
            const validationStatus = document.getElementById('validation-status');
            
            if (!provider) {
                validationStatus.style.display = 'none';
                return;
            }
            
            // Show loading status
            validationStatus.style.display = 'block';
            validationStatus.className = 'validation-status loading';
            validationStatus.textContent = `üîÑ Validating ${provider} models...`;
            
            try {
                const response = await fetch(`${API_BASE}/api/models/${provider}`);
                const data = await response.json();
                
                const models = data.models || data; // Support both new and old format
                const validation = data.validation;
                
                const select = document.getElementById('model');
                select.innerHTML = '<option value="">Select Model...</option>';
                
                // Check if we have models
                if (models.length === 0) {
                    // No models available
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No validated models available';
                    option.disabled = true;
                    select.appendChild(option);
                    
                    validationStatus.className = 'validation-status warning';
                    validationStatus.style.display = 'block';
                    if (validation && validation.error) {
                        validationStatus.textContent = `‚ö†Ô∏è ${validation.error}`;
                    } else {
                        validationStatus.textContent = `‚ö†Ô∏è No models could be validated. Check API key configuration.`;
                    }
                } else {
                    // Group models by category
                    const groupedModels = {};
                    models.forEach(model => {
                        // Handle both old format (string) and new format (object)
                        const modelId = typeof model === 'string' ? model : model.id;
                        const displayName = typeof model === 'string' ? model : model.display_name;
                        const description = typeof model === 'string' ? '' : model.description;
                        const category = typeof model === 'string' ? '' : model.category;
                        const supportsVision = typeof model === 'string' ? false : model.supports_vision;
                        const reasoningModel = typeof model === 'string' ? false : model.reasoning_model;
                        
                        if (!groupedModels[category]) {
                            groupedModels[category] = [];
                        }
                        groupedModels[category].push({ modelId, displayName, description, supportsVision, reasoningModel });
                    });
                    
                    // Add models to dropdown with categories
                    Object.keys(groupedModels).forEach(category => {
                        // Add category header if not empty
                        if (category) {
                            const categoryOption = document.createElement('option');
                            categoryOption.disabled = true;
                            categoryOption.textContent = `‚îÄ‚îÄ ${category} ‚îÄ‚îÄ`;
                            categoryOption.style.fontWeight = 'bold';
                            categoryOption.style.color = '#666';
                            select.appendChild(categoryOption);
                        }
                        
                        // Add models in this category
                        groupedModels[category].forEach(({ modelId, displayName, description, supportsVision, reasoningModel }) => {
                            const option = document.createElement('option');
                            option.value = modelId;
                            
                            // Build display text with labels
                            let text = displayName;
                            if (description) {
                                text += ` - ${description}`;
                            }
                            
                            option.textContent = text;
                            option.title = description; // Tooltip
                            select.appendChild(option);
                        });
                    });
                    
                    // Display validation feedback - always show status after load
                    validationStatus.style.display = 'block';
                    if (validation) {
                        if (validation.error) {
                            validationStatus.className = 'validation-status warning';
                            validationStatus.textContent = `‚ö†Ô∏è Default models displayed. Could not validate models.`;
                        } else {
                            // Success - clear any previous warnings
                            validationStatus.className = 'validation-status success';
                            validationStatus.textContent = `‚úì Validated ${models.length} models (${validation.validation_time_ms}ms)`;
                        }
                    } else {
                        // No validation data - show neutral status
                        validationStatus.className = 'validation-status';
                        validationStatus.textContent = `‚ÑπÔ∏è ${models.length} models loaded`;
                    }
                }
            } catch (error) {
                console.error('Error loading models:', error);
                validationStatus.className = 'validation-status warning';
                validationStatus.textContent = `‚ö†Ô∏è Error loading models: ${error.message}`;
            }
            
            // Reset temperature state when provider changes
            updateTemperatureState();
        });
        
        // Update temperature state and context window when model changes
        document.getElementById('model').addEventListener('change', async () => {
            await updateTemperatureState();
            await updateContextWindow();
        });
        
        // Update context window display and file input capabilities
        async function updateContextWindow() {
            const provider = document.getElementById('provider').value;
            const model = document.getElementById('model').value;
            const contextDisplay = document.getElementById('context-window');
            const fileInput = document.getElementById('file-input');
            const fileLabel = document.getElementById('file-input-label');
            
            if (!provider || !model) {
                contextDisplay.textContent = '-';
                // Reset to text files only
                fileInput.accept = '.txt,.py,.js,.json,.csv,.log,.md,.yaml,.yml,.xml,.html,.css,.java,.go,.rs,.cpp,.c,.h';
                fileLabel.textContent = 'Attach File (optional) - Text files only';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/model-info/${provider}/${model}`);
                if (response.ok) {
                    const modelInfo = await response.json();
                    
                    // Update context window
                    const context = modelInfo.context;
                    if (context && typeof context === 'number' && context > 0) {
                        contextDisplay.textContent = `${context.toLocaleString()} tokens`;
                    } else {
                        contextDisplay.textContent = 'N/A';
                    }
                    
                    // Update file input based on vision support
                    if (modelInfo.supports_vision) {
                        fileInput.accept = '.txt,.py,.js,.json,.csv,.log,.md,.yaml,.yml,.xml,.html,.css,.java,.go,.rs,.cpp,.c,.h,.jpg,.jpeg,.png,.gif,.webp';
                        fileLabel.textContent = 'Attach File (optional) - Text files and images (vision enabled)';
                    } else {
                        fileInput.accept = '.txt,.py,.js,.json,.csv,.log,.md,.yaml,.yml,.xml,.html,.css,.java,.go,.rs,.cpp,.c,.h';
                        fileLabel.textContent = 'Attach File (optional) - Text files only';
                    }
                } else {
                    contextDisplay.textContent = '-';
                    // Reset to text files only on error
                    fileInput.accept = '.txt,.py,.js,.json,.csv,.log,.md,.yaml,.yml,.xml,.html,.css,.java,.go,.rs,.cpp,.c,.h';
                    fileLabel.textContent = 'Attach File (optional) - Text files only';
                }
            } catch (error) {
                console.error('Error fetching model info:', error);
                contextDisplay.textContent = '-';
                // Reset to text files only on error
                fileInput.accept = '.txt,.py,.js,.json,.csv,.log,.md,.yaml,.yml,.xml,.html,.css,.java,.go,.rs,.cpp,.c,.h';
                fileLabel.textContent = 'Attach File (optional) - Text files only';
            }
        }
        
        // Update temperature display
        document.getElementById('temperature').addEventListener('input', (e) => {
            document.getElementById('temp-value').textContent = e.target.value;
        });
        
        // Handle chunking checkbox toggle
        document.getElementById('chunked').addEventListener('change', (e) => {
            const chunkSizeGroup = document.getElementById('chunk-size-group');
            chunkSizeGroup.style.display = e.target.checked ? 'block' : 'none';
        });
        
        // Update chunk size display
        document.getElementById('chunk-size').addEventListener('input', (e) => {
            document.getElementById('chunk-size-value').textContent = parseInt(e.target.value).toLocaleString();
        });
        
        // Configure marked for code highlighting
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });
        
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active from all tabs and contents
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Activate clicked tab and its content
                btn.classList.add('active');
                document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
            });
        });
        
        // Update message history display
        function updateMessageHistory() {
            const historyList = document.getElementById('history-list');
            
            // Filter out system messages and get last 15
            const recentMessages = messages.slice(-15);
            
            if (recentMessages.length === 0) {
                historyList.innerHTML = '<div class="history-empty">No messages yet</div>';
                return;
            }
            
            let html = '';
            for (const msg of recentMessages) {
                const roleIcon = msg.role === 'user' ? 'üë§' : 'ü§ñ';
                // Truncate long messages
                const truncated = msg.content.length > 80 ? msg.content.substring(0, 80) + '...' : msg.content;
                // Escape HTML
                const escaped = truncated.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                html += `<div class="history-item">
                    <span class="history-role ${msg.role}">${roleIcon} ${msg.role}:</span>
                    <span class="history-content">${escaped}</span>
                </div>`;
            }
            
            historyList.innerHTML = html;
        }
        
        // Add message to chat
        function addMessage(role, content, details = null) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            // Add error details if provided
            if (details && role === 'error') {
                // Create main message text node
                const mainText = document.createTextNode(content);
                messageDiv.appendChild(mainText);
                
                // Create details section
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'error-details';
                detailsDiv.textContent = details;
                messageDiv.appendChild(detailsDiv);
            } else if (role === 'assistant') {
                // Render markdown for assistant messages
                const markdownDiv = document.createElement('div');
                markdownDiv.className = 'markdown-content';
                markdownDiv.innerHTML = marked.parse(content);
                messageDiv.appendChild(markdownDiv);
            } else {
                // For user/system messages, just set text content
                messageDiv.textContent = content;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            // Don't add error messages to conversation history
            if (role !== 'error' && role !== 'system') {
                messages.push({role, content});
                updateMessageHistory();
            }
        }
        
        // Handle file selection
        let selectedFile = null;
        let fileContent = null;
        
        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            const fileStatus = document.getElementById('file-status');
            
            if (!file) {
                selectedFile = null;
                fileContent = null;
                fileStatus.textContent = '';
                return;
            }
            
            // Check file size (5MB limit)
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                fileStatus.textContent = `‚ö†Ô∏è File too large (${(file.size / 1024 / 1024).toFixed(2)} MB). Max: 5 MB`;
                fileStatus.style.color = '#c33';
                e.target.value = ''; // Clear selection
                selectedFile = null;
                fileContent = null;
                return;
            }
            
            // Read file content - handle text and image files differently
            try {
                const fileType = file.type;
                const isImage = fileType.startsWith('image/');
                
                if (isImage) {
                    // Read image as base64 data URL
                    const reader = new FileReader();
                    await new Promise((resolve, reject) => {
                        reader.onload = (e) => {
                            fileContent = e.target.result;  // base64 data URL
                            resolve();
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    selectedFile = file;
                    const sizeStr = file.size < 1024 ? 
                        `${file.size} bytes` : 
                        file.size < 1024 * 1024 ? 
                        `${(file.size / 1024).toFixed(1)} KB` : 
                        `${(file.size / 1024 / 1024).toFixed(2)} MB`;
                    fileStatus.textContent = `‚úì ${file.name} (${sizeStr}, image)`;
                    fileStatus.style.color = '#22c55e';
                } else {
                    // Read text file
                    fileContent = await file.text();
                    selectedFile = file;
                    const sizeStr = file.size < 1024 ? 
                        `${file.size} bytes` : 
                        file.size < 1024 * 1024 ? 
                        `${(file.size / 1024).toFixed(1)} KB` : 
                        `${(file.size / 1024 / 1024).toFixed(2)} MB`;
                    fileStatus.textContent = `‚úì ${file.name} (${sizeStr}, ${fileContent.length.toLocaleString()} chars)`;
                    fileStatus.style.color = '#22c55e';
                }
            } catch (error) {
                fileStatus.textContent = `‚ö†Ô∏è Error reading file: ${error.message}`;
                fileStatus.style.color = '#c33';
                e.target.value = '';
                selectedFile = null;
                fileContent = null;
            }
        });
        
        // Send message
        document.getElementById('send-btn').addEventListener('click', async () => {
            const provider = document.getElementById('provider').value;
            const model = document.getElementById('model').value;
            const input = document.getElementById('user-input');
            const userMessage = input.value.trim();
            const fileInput = document.getElementById('file-input');
            const fileStatus = document.getElementById('file-status');
            
            if (!provider || !model) {
                alert('Please select provider and model');
                return;
            }
            
            if (!userMessage && !fileContent) {
                alert('Please enter a message or attach a file');
                return;
            }
            
            // Validate that vision models are used for image files
            if (fileContent && selectedFile) {
                const isImage = selectedFile.type.startsWith('image/');
                if (isImage) {
                    // Check if model supports vision
                    try {
                        const response = await fetch(`${API_BASE}/api/model-info/${provider}/${model}`);
                        if (response.ok) {
                            const modelInfo = await response.json();
                            if (!modelInfo.supports_vision) {
                                alert(`‚ùå Vision Not Supported\n\nThe model "${model}" cannot process image files.\n\nPlease either:\n‚Ä¢ Select a vision-capable model (e.g., GPT-4 Vision, Claude 3), or\n‚Ä¢ Remove the image attachment`);
                                return;
                            }
                        }
                    } catch (error) {
                        console.error('Error checking vision support:', error);
                        // Continue anyway - let the API handle it
                    }
                }
            }
            
            // Build display message and actual content
            let displayMessage = userMessage;
            let actualContent = userMessage;
            let apiFileContent = null;
            let apiFileName = null;
            
            if (fileContent) {
                const isImage = selectedFile.type.startsWith('image/');
                
                if (isImage) {
                    // For images, show indicator in display
                    displayMessage = displayMessage ? 
                        `${displayMessage}\n\nüñºÔ∏è Image attached: ${selectedFile.name}` : 
                        `üñºÔ∏è Image attached: ${selectedFile.name}`;
                    
                    // Extract base64 data from data URL (format: data:image/jpeg;base64,<data>)
                    const base64Data = fileContent.split(',')[1];  // Get part after comma
                    const mimeType = fileContent.split(';')[0].split(':')[1];  // Extract mime type
                    
                    // Format for vision models: [IMAGE:mime_type]\nbase64_data
                    const imageContent = `[IMAGE:${mimeType}]\n${base64Data}`;
                    
                    actualContent = actualContent ? 
                        `${actualContent}\n\n${imageContent}` : 
                        imageContent;
                } else {
                    // For text files, set API file parameters for chunking support
                    displayMessage = displayMessage ? 
                        `${displayMessage}\n\nüìé Attached: ${selectedFile.name}` : 
                        `üìé Attached: ${selectedFile.name}`;
                    
                    // Check if chunking is enabled
                    const chunked = document.getElementById('chunked').checked;
                    if (chunked) {
                        // Pass file to API for chunking
                        apiFileContent = fileContent;
                        apiFileName = selectedFile.name;
                        displayMessage += ` (chunking enabled)`;
                    } else {
                        // Combine message with file content directly
                        actualContent = actualContent ? 
                            `${actualContent}\n\n[File: ${selectedFile.name}]\n\n${fileContent}` : 
                            `[File: ${selectedFile.name}]\n\n${fileContent}`;
                    }
                }
            }
            
            // Add user message to chat display
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.textContent = displayMessage;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            // Add actual content (with file) to conversation history
            messages.push({role: 'user', content: actualContent});
            
            input.value = '';
            
            // Clear file attachment
            if (fileContent) {
                fileInput.value = '';
                fileStatus.textContent = '';
                selectedFile = null;
                fileContent = null;
            }
            
            // Disable send button
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading"></span> Sending...';
            
            try {
                // Prepare request
                let temperature = parseFloat(document.getElementById('temperature').value);
                const maxTokensInput = document.getElementById('max-tokens').value;
                const maxTokens = maxTokensInput ? parseInt(maxTokensInput) : null;
                
                // Force temperature to 1.0 for reasoning models
                if (isReasoningModel(model)) {
                    temperature = 1.0;
                }
                
                // Build request body with optional chunking parameters
                const requestBody = {
                    provider,
                    model,
                    messages: messages,
                    temperature,
                    max_tokens: maxTokens,
                };
                
                // Add file and chunking parameters if file is being chunked
                if (apiFileContent && apiFileName) {
                    requestBody.file_content = apiFileContent;
                    requestBody.file_name = apiFileName;
                    requestBody.chunked = true;
                    requestBody.chunk_size = parseInt(document.getElementById('chunk-size').value);
                }
                
                const response = await fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                // Check for API errors
                if (!response.ok) {
                    // Handle structured error response (object) or simple error (string)
                    let errorMsg;
                    let errorData = null;
                    
                    if (typeof data.detail === 'object' && data.detail !== null) {
                        // Structured error response from our API
                        errorData = data.detail;
                        errorMsg = errorData.detail || errorData.message || JSON.stringify(data.detail);
                    } else {
                        // Simple string error
                        errorMsg = data.detail || data.error || 'Unknown error occurred';
                    }
                    
                    let userFriendlyMsg = 'API Error';
                    let details = errorMsg;
                    
                    // Parse common error patterns
                    if (errorData && errorData.error === 'input_too_long') {
                        // Enhanced token limit error with suggestions
                        userFriendlyMsg = 'üìä Input Too Large';
                        
                        const msg = errorData.message || errorMsg;
                        const suggestion = errorData.suggestion || '';
                        const tokens = errorData.estimated_tokens;
                        const limit = errorData.api_limit || errorData.model_limit;
                        const chunkingEnabled = errorData.chunking_enabled;
                        
                        details = `${msg}\n\n`;
                        
                        if (suggestion) {
                            details += `üí° Suggestions:\n${suggestion}\n\n`;
                        }
                        
                        if (!chunkingEnabled) {
                            details += `‚ö†Ô∏è TIP: Enable the 'Smart Chunking' checkbox below the file upload to automatically reduce token usage by 40-90%.`;
                        }
                    } else if (errorData && errorData.error === 'content_too_large') {
                        // File exceeds system maximum
                        userFriendlyMsg = 'üö´ File Too Large';
                        details = `${errorData.message}\n\n${errorData.suggestion || ''}`;
                    } else if (errorMsg.includes('temperature') && errorMsg.includes('not support')) {
                        const selectedTemp = parseFloat(document.getElementById('temperature').value);
                        userFriendlyMsg = `${model} does not support temperature ${selectedTemp}. The default value is 1.0.`;
                        details = errorMsg;
                    } else if (errorMsg.includes('authentication') || errorMsg.includes('api key')) {
                        userFriendlyMsg = 'üîë Authentication Error';
                        details = `API key is missing or invalid for ${provider}.\n\nError: ${errorMsg}\n\nPlease check your .env file.`;
                    } else if (errorMsg.includes('rate limit')) {
                        userFriendlyMsg = '‚è±Ô∏è Rate Limit Exceeded';
                        details = `Too many requests to ${provider}.\n\nError: ${errorMsg}\n\nPlease wait a moment and try again.`;
                    } else if (errorMsg.includes('model') && errorMsg.includes('not found')) {
                        userFriendlyMsg = 'üîç Model Not Found';
                        details = `The model \"${model}\" is not available.\n\nError: ${errorMsg}`;
                    }
                    
                    addMessage('error', userFriendlyMsg, details);
                    return;
                }
                
                // Add assistant response
                addMessage('assistant', data.content);
                
                // Update cost tracking
                totalCalls++;
                totalTokens += data.usage?.total_tokens || 0;
                totalPromptTokens += data.usage?.prompt_tokens || 0;
                totalCompletionTokens += data.usage?.completion_tokens || 0;
                totalCost += data.cost_usd || 0;
                
                document.getElementById('cost-calls').textContent = totalCalls;
                document.getElementById('cost-tokens').textContent = 
                    `${totalTokens.toLocaleString()} (In: ${totalPromptTokens.toLocaleString()}, Out: ${totalCompletionTokens.toLocaleString()})`;
                document.getElementById('cost-total').textContent = `$${totalCost.toFixed(4)}`;
                
            } catch (error) {
                // Network or parsing errors
                addMessage('error', 'üåê Connection Error', `Failed to communicate with the API.\n\nError: ${error.message}\n\nPlease check if the server is running.`);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send Message';
            }
        });
        
        // Reset chat
        document.getElementById('reset-chat').addEventListener('click', () => {
            messages = [];
            document.getElementById('chat-container').innerHTML = '';
            updateMessageHistory();
            addMessage('system', 'Chat reset. Start a new conversation.');
        });
        
        // Initialize
        loadProviders();
        addMessage('system', 'Welcome to StratifyAI! Select a provider and model to start chatting.');
    </script>
</body>
</html>
